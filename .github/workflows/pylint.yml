name: Pylint Code Quality

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  pylint-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        
    - name: Display Python version
      run: python -c "import sys; print(f'Python {sys.version}')"
      
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install pylint
        pip install aiohttp
        pip install asyncio
        pip install psutil
        # Alternative async support - use pylint's built-in async support
        pip install pylint-plugin-utils || echo "Optional plugin not available"
        
    - name: Create minimal .pylintrc
      run: |
        cat > .pylintrc << 'EOF'
        [MASTER]
        jobs=0
        persistent=yes
        fail-under=7.0
        
        [MESSAGES CONTROL]
        disable=
            missing-module-docstring,
            missing-class-docstring,
            missing-function-docstring,
            too-many-arguments,
            too-many-locals,
            too-many-statements,
            too-many-branches,
            too-many-instance-attributes,
            too-few-public-methods,
            too-many-public-methods,
            duplicate-code,
            broad-except,
            line-too-long,
            invalid-name,
            redefined-outer-name,
            global-statement,
            unused-argument,
            protected-access,
            consider-using-f-string,
            fixme,
            wildcard-import,
            unused-wildcard-import
        
        [FORMAT]
        max-line-length=100
        ignore-long-lines=^\s*(# )?<?https?://\S+>?$
        
        [BASIC]
        good-names=i,j,k,ex,Run,_
        bad-names=foo,bar,baz,tmp,temp
        
        [DESIGN]
        max-args=8
        max-locals=20
        max-returns=6
        max-branches=20
        max-statements=60
        max-attributes=12
        EOF
        
    - name: Find Python files
      id: find-files
      run: |
        # Find all Python files excluding virtual envs and cache
        find . -name "*.py" \
          -not -path "./.venv/*" \
          -not -path "./venv/*" \
          -not -path "./env/*" \
          -not -path "./.env/*" \
          -not -path "./__pycache__/*" \
          -not -path "./.git/*" \
          -not -path "./tests/__pycache__/*" \
          > python-files.txt
        
        echo "Found $(wc -l < python-files.txt) Python files"
        cat python-files.txt
        
    - name: Run Pylint
      id: pylint-run
      continue-on-error: true
      run: |
        echo "Running Pylint analysis..."
        
        # Create reports directory
        mkdir -p pylint-reports
        
        # Run pylint
        pylint \
          --rcfile=.pylintrc \
          --output=pylint-reports/report.txt \
          --exit-zero \
          --reports=y \
          $(cat python-files.txt) 2>&1 | tee pylint-reports/output.log || true
        
        # Extract score
        score=$(grep -E "Your code has been rated at" pylint-reports/output.log | grep -oE "[0-9]+\.[0-9]+" | head -1 || echo "0")
        echo "Pylint Score: $score"
        echo "score=$score" >> $GITHUB_OUTPUT
        
        # Count issues
        errors=$(grep -c ": error" pylint-reports/output.log 2>/dev/null || echo "0")
        warnings=$(grep -c ": warning" pylint-reports/output.log 2>/dev/null || echo "0")
        echo "errors=$errors" >> $GITHUB_OUTPUT
        echo "warnings=$warnings" >> $GITHUB_OUTPUT
        
    - name: Display Results
      if: always()
      run: |
        echo "ðŸ“Š PYLINT RESULTS"
        echo "================="
        echo ""
        
        score="${{ steps.pylint-run.outputs.score }}"
        errors="${{ steps.pylint-run.outputs.errors }}"
        warnings="${{ steps.pylint-run.outputs.warnings }}"
        
        echo "Score: $score/10"
        echo "Errors: $errors"
        echo "Warnings: $warnings"
        echo ""
        
        if [ -f pylint-reports/output.log ]; then
          # Show summary
          echo "ðŸ“‹ SUMMARY:"
          grep -A 3 "Your code has been rated at" pylint-reports/output.log || echo "No summary found"
          echo ""
          
          # Show top issues
          if [ "$errors" -gt 0 ] || [ "$warnings" -gt 0 ]; then
            echo "ðŸ” TOP ISSUES:"
            grep -E ": (error|warning)" pylint-reports/output.log | head -10 || echo "No issues to display"
          fi
        fi
        
    - name: Check Score Threshold
      id: check-threshold
      run: |
        score="${{ steps.pylint-run.outputs.score }}"
        threshold="7.0"
        
        if [ -z "$score" ] || [ "$score" = "0" ]; then
          echo "âŒ Could not determine pylint score"
          exit 1
        fi
        
        echo "Score: $score"
        echo "Threshold: $threshold"
        
        # Use awk for floating point comparison
        if awk "BEGIN {exit !($score >= $threshold)}"; then
          echo "âœ… Pylint score meets threshold"
          echo "pass=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Pylint score below threshold"
          echo "pass=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: Upload Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pylint-report-${{ matrix.python-version }}
        path: |
          pylint-reports/
          .pylintrc
          python-files.txt
        retention-days: 7
        
  quality-summary:
    runs-on: ubuntu-latest
    needs: pylint-check
    if: always()
    
    steps:
    - name: Generate Summary
      run: |
        echo "ðŸŽ¯ CODE QUALITY SUMMARY"
        echo "======================="
        echo ""
        echo "Python versions tested: ${{ join(needs.pylint-check.outputs.*.python-version, ', ') }}"
        echo ""
        
        # Get scores from all matrix runs
        echo "ðŸ“ˆ SCORES PER PYTHON VERSION:"
        # This would iterate through matrix results in a real scenario
        echo "All checks completed. See individual jobs for details."
        echo ""
        echo "âœ… Recommendation: Maintain score above 7.0"
