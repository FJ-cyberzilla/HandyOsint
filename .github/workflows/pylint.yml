name: Pylint Code Quality

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # Run weekly on Sunday at midnight

jobs:
  code-quality:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
        os: [ubuntu-latest]
    
    env:
      PYTHONPATH: ${{ github.workspace }}
      PYLINTRC: ${{ github.workspace }}/.pylintrc
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        
    - name: Display Python version
      run: python -c "import sys; print(f'Python {sys.version}')"
      
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3-dev
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install --upgrade pylint==3.0.3
        pip install --upgrade pylint-asyncio==0.3.1
        pip install --upgrade pylint-django==2.5.3
        pip install --upgrade djangorestframework
        pip install --upgrade aiohttp
        pip install --upgrade asyncio
        pip install --upgrade psutil
        
    - name: Create .pylintrc configuration
      run: |
        cat > .pylintrc << 'EOF'
        [MASTER]
        jobs=4
        persistent=yes
        load-plugins=pylint_asyncio
        fail-under=7.5
        
        [MESSAGES CONTROL]
        disable=
            missing-module-docstring,
            missing-class-docstring,
            missing-function-docstring,
            too-many-arguments,
            too-many-locals,
            too-many-statements,
            too-many-branches,
            too-many-instance-attributes,
            too-few-public-methods,
            too-many-public-methods,
            duplicate-code,
            broad-except,
            line-too-long,
            invalid-name,
            redefined-outer-name,
            global-statement,
            unused-argument,
            protected-access,
            consider-using-f-string,
            fixme,
            duplicate-code,
            wildcard-import,
            unused-wildcard-import
            
        enable=c-extension-no-member
        
        [REPORTS]
        output-format=colorized
        files-output=no
        reports=yes
        score=yes
        evaluation=10.0 - ((float(5 * error + warning + refactor + convention) / statement) * 10)
        
        [FORMAT]
        max-line-length=100
        ignore-long-lines=^\s*(# )?<?https?://\S+>?$
        single-line-if-stmt=no
        max-module-lines=1000
        indent-string='    '
        
        [BASIC]
        good-names=i,j,k,ex,Run,_
        bad-names=foo,bar,baz,tmp,temp
        name-group=
        include-naming-hint=no
        
        [DESIGN]
        max-args=8
        max-locals=20
        max-returns=6
        max-branches=20
        max-statements=60
        max-parents=7
        max-attributes=12
        min-public-methods=0
        max-public-methods=30
        
        [SIMILARITIES]
        min-similarity-lines=8
        ignore-comments=yes
        ignore-docstrings=yes
        ignore-imports=yes
        
        [VARIABLES]
        init-import=no
        dummy-variables-rgx=_+$|(_[a-zA-Z0-9]*?$)
        additional-builtins=
        
        [LOGGING]
        logging-modules=logging,log
        
        [TYPECHECK]
        ignored-modules=
        ignored-classes=optparse.Values,thread._local,_thread._local
        generated-members=REQUEST,acl_users,aq_parent
        
        [ASYNC]
        # Async-specific configurations
        async-required-decorators=asyncio.coroutine
        async-disabled-decorators=
        
        [CLASSES]
        defining-attr-methods=__init__,__new__,setUp,__post_init__
        valid-classmethod-first-arg=cls
        valid-metaclass-classmethod-first-arg=mcs
        
        [EXCEPTIONS]
        overgeneral-exceptions=Exception
        
        [IMPORTS]
        deprecated-modules=
        no-docstring-rgx=^_
        
        [STRING]
        check-str-concat-over-line-jumps=no
        EOF
        
    - name: Create requirements.txt for testing
      run: |
        cat > requirements.txt << 'EOF'
        aiohttp>=3.9.0
        asyncio>=3.4.3
        psutil>=5.9.0
        rich>=13.0.0
        colorama>=0.4.0
        python-dotenv>=1.0.0
        pyyaml>=6.0.0
        EOF
        
    - name: Run Pylint with configuration
      id: pylint
      run: |
        echo "Running Pylint analysis..."
        
        # Create output directory
        mkdir -p pylint-reports
        
        # Run pylint on all Python files
        pylint_output=$(pylint \
          --rcfile=.pylintrc \
          --output=pylint-reports/pylint-report.txt \
          --exit-zero \
          $(find . -name "*.py" -not -path "./.venv/*" -not -path "./venv/*" -not -path "./env/*" -not -path "./.env/*") \
          2>&1 || true)
        
        # Extract score
        pylint_score=$(echo "$pylint_output" | grep -E "Your code has been rated at" | grep -oE "[0-9]+\.[0-9]+" | head -1 || echo "0")
        
        echo "Pylint Score: $pylint_score"
        echo "score=$pylint_score" >> $GITHUB_OUTPUT
        
        # Save detailed output
        echo "$pylint_output" > pylint-reports/detailed-output.txt
        
    - name: Generate Pylint Report
      if: always()
      run: |
        echo "üìä PYLINT ANALYSIS REPORT"
        echo "========================="
        
        if [ -f pylint-reports/pylint-report.txt ]; then
          cat pylint-reports/pylint-report.txt
          
          # Count issues by type
          echo ""
          echo "üìà ISSUE SUMMARY:"
          echo "----------------"
          
          if [ -f pylint-reports/detailed-output.txt ]; then
            errors=$(grep -c ": error" pylint-reports/detailed-output.txt || echo "0")
            warnings=$(grep -c ": warning" pylint-reports/detailed-output.txt || echo "0")
            refactors=$(grep -c ": refactor" pylint-reports/detailed-output.txt || echo "0")
            conventions=$(grep -c ": convention" pylint-reports/detailed-output.txt || echo "0")
            
            echo "Errors: $errors"
            echo "Warnings: $warnings"
            echo "Refactor suggestions: $refactors"
            echo "Convention violations: $conventions"
            
            # Calculate quality score
            total_issues=$((errors + warnings + refactors + conventions))
            echo "Total issues: $total_issues"
          fi
        else
          echo "No pylint report generated."
        fi
        
    - name: Check Pylint Score Threshold
      run: |
        # Read score from previous step
        score="${{ steps.pylint.outputs.score }}"
        
        if [ -z "$score" ]; then
          echo "‚ùå Could not determine pylint score"
          exit 1
        fi
        
        # Convert to integer for comparison (multiply by 10)
        score_int=$(echo "$score * 10" | bc | cut -d. -f1)
        threshold=75  # 7.5 * 10
        
        echo "Score: $score (integer: $score_int)"
        echo "Threshold: $threshold"
        
        if [ "$score_int" -lt "$threshold" ]; then
          echo "‚ùå Pylint score $score is below threshold 7.5"
          echo "Please fix code quality issues before merging."
          
          # Show top issues if available
          if [ -f pylint-reports/detailed-output.txt ]; then
            echo ""
            echo "üîù TOP 10 ISSUES TO FIX:"
            echo "------------------------"
            grep -E ": (error|warning)" pylint-reports/detailed-output.txt | head -10
          fi
          
          exit 1
        else
          echo "‚úÖ Pylint score $score meets threshold 7.5"
        fi
        
    - name: Upload Pylint Reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: pylint-reports-${{ matrix.python-version }}
        path: |
          pylint-reports/
          .pylintrc
        retention-days: 30
        
    - name: Comment on Pull Request
      if: github.event_name == 'pull_request' && failure()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          try {
            const report = fs.readFileSync('pylint-reports/detailed-output.txt', 'utf8');
            
            // Extract top issues
            const lines = report.split('\n');
            const topIssues = lines
              .filter(line => line.includes(': error') || line.includes(': warning'))
              .slice(0, 5)
              .map(line => `- ${line.trim()}`)
              .join('\n');
            
            const score = "${{ steps.pylint.outputs.score }}" || 'N/A';
            
            const commentBody = `## üîç Pylint Code Quality Check Failed
            
            **Score:** ${score}/10 (Minimum required: 7.5)
            
            ### Top Issues to Fix:
            ${topIssues || 'No specific issues found'}
            
            ### Next Steps:
            1. Review the full report in the artifacts
            2. Fix the highlighted issues
            3. Run \`pylint\` locally before pushing again
            
            üìÅ **Full Report:** [Download artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
          } catch (error) {
            console.error('Failed to create PR comment:', error);
          }
        
    - name: Create Quality Badge
      if: success()
      run: |
        score="${{ steps.pylint.outputs.score }}"
        badge_color="brightgreen"
        
        # Determine badge color based on score
        if (( $(echo "$score < 6" | bc -l) )); then
          badge_color="red"
        elif (( $(echo "$score < 7.5" | bc -l) )); then
          badge_color="orange"
        elif (( $(echo "$score < 9" | bc -l) )); then
          badge_color="yellow"
        else
          badge_color="brightgreen"
        fi
        
        # Create badge URL (for reference)
        badge_url="https://img.shields.io/badge/pylint-$score-$badge_color"
        echo "Badge URL: $badge_url"
        echo "quality_score=$score" >> $GITHUB_ENV
        
    - name: Send Notification on Failure
      if: failure() && github.event_name == 'push'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#code-quality'
        author_name: Pylint Bot
        fields: repo,commit,message,author,action
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  security-scan:
    runs-on: ubuntu-latest
    needs: [code-quality]
    if: success() || failure()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Bandit Security Scan
      run: |
        pip install bandit
        bandit -r . -f html -o security-report.html || true
        
    - name: Upload Security Report
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: security-report.html
        
  documentation-check:
    runs-on: ubuntu-latest
    needs: [code-quality]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check Docstring Coverage
      run: |
        pip install interrogate
        interrogate --version
        interrogate --fail-under=80 . || echo "Docstring coverage below 80%"
        
  performance-test:
    runs-on: ubuntu-latest
    needs: [code-quality]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Run Performance Tests
      run: |
        echo "Performance tests would run here"
        # Add your performance test commands
        
  notify-success:
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, documentation-check, performance-test]
    if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Send Success Notification
      run: |
        echo "‚úÖ All quality checks passed!"
        echo "Pylint Score: ${{ needs.code-quality.outputs.score }}"
