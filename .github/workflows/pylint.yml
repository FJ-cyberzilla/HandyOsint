name: Pylint Code Quality

permissions:
  contents: read

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  pylint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]  # Start with one version for simplicity
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint
        
    - name: List Python files
      run: |
        echo "üîç Looking for Python files..."
        find . -type f -name "*.py" | grep -v __pycache__ | grep -v ".venv" | grep -v "venv" | head -20
        echo "Total files found:"
        find . -type f -name "*.py" | grep -v __pycache__ | grep -v ".venv" | grep -v "venv" | wc -l
        
    - name: Create .pylintrc with minimal settings
      run: |
        cat > .pylintrc << 'EOF'
        [MASTER]
        fail-under=6.0  # Lower threshold for initial run
        
        [MESSAGES CONTROL]
        disable=missing-docstring, line-too-long, invalid-name
        
        [FORMAT]
        max-line-length=120
        
        [BASIC]
        good-names=i,j,k,ex,Run,_
        EOF
        
    - name: Run Pylint on specific files
      id: run-pylint
      continue-on-error: true
      run: |
        echo "üìä Running Pylint..."
        
        # Try to find your main application files
        MAIN_FILES=""
        
        # Look for your Social Scan files
        if [ -f "social_scan_main.py" ]; then
          MAIN_FILES="social_scan_main.py"
        elif [ -f "main.py" ]; then
          MAIN_FILES="main.py"
        else
          # Find any Python files in root
          MAIN_FILES=$(find . -maxdepth 1 -name "*.py" | head -5 | tr '\n' ' ')
        fi
        
        if [ -z "$MAIN_FILES" ]; then
          # Find any Python files
          MAIN_FILES=$(find . -name "*.py" -not -path "*/__pycache__/*" -not -path "*/.venv/*" -not -path "*/venv/*" | head -10 | tr '\n' ' ')
        fi
        
        echo "Files to analyze: $MAIN_FILES"
        
        if [ -z "$MAIN_FILES" ]; then
          echo "‚ùå No Python files found to analyze"
          echo "score=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Run pylint and capture output
        pylint_output=$(pylint $MAIN_FILES --rcfile=.pylintrc --exit-zero 2>&1)
        echo "$pylint_output"
        
        # Try different patterns to extract score
        score=$(echo "$pylint_output" | grep -E "Your code has been rated at" | grep -oE "[0-9]+\.[0-9]+" | head -1)
        
        if [ -z "$score" ]; then
          # Try alternative pattern
          score=$(echo "$pylint_output" | grep -E "rated at" | grep -oE "[0-9]+\.[0-9]+" | head -1)
        fi
        
        if [ -z "$score" ]; then
          # If still no score, check if pylint ran successfully
          if echo "$pylint_output" | grep -q "error"; then
            echo "‚ö†Ô∏è  Pylint encountered errors"
            score="0"
          else
            # Assume perfect score if no issues found
            score="10.0"
          fi
        fi
        
        echo "‚úÖ Pylint score: $score"
        echo "score=$score" >> $GITHUB_OUTPUT
        
    - name: Check if score is valid
      run: |
        score="${{ steps.run-pylint.outputs.score }}"
        
        if [ "$score" = "0" ]; then
          echo "‚ö†Ô∏è  Warning: Score is 0. This might mean no Python files were analyzed."
          echo "Check the 'List Python files' step above to see what files were found."
        elif [ "$score" = "10.0" ]; then
          echo "üéâ Perfect score! Either your code is excellent or Pylint didn't find any files."
        else
          echo "üìà Score: $score/10"
          
          # Convert to integer for comparison
          score_int=$(echo "$score" | cut -d. -f1)
          
          if [ "$score_int" -lt 6 ]; then
            echo "‚ùå Score below 6.0 - needs improvement"
            exit 1
          elif [ "$score_int" -lt 8 ]; then
            echo "‚ö†Ô∏è  Score between 6.0-7.9 - acceptable"
          else
            echo "‚úÖ Score 8.0+ - excellent!"
          fi
        fi
        
    - name: Create summary report
      if: always()
      run: |
        echo "üìã PYTHON CODE QUALITY REPORT"
        echo "=============================="
        echo ""
        echo "Python Version: ${{ matrix.python-version }}"
        echo "Pylint Score: ${{ steps.run-pylint.outputs.score || 'N/A' }}/10"
        echo ""
        echo "üìÅ Files analyzed:"
        find . -name "*.py" -not -path "*/__pycache__/*" -not -path "*/.venv/*" -not -path "*/venv/*" | head -10
        echo ""
        echo "‚úÖ Next steps:"
        echo "1. Aim for a score above 7.0"
        echo "2. Fix any reported issues"
        echo "3. Add more Python files to the analysis"
